<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium å«æ˜Ÿé”¥ä½“æŠ•å½±å¯è§†åŒ– PRD æ¼”ç¤º</title>
    <script>window.CESIUM_BASE_URL = 'https://cdn.jsdelivr.net/npm/cesium@1.133/Build/Cesium/';</script>
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.133/Build/Cesium/Widgets/widgets.min.css" rel="stylesheet">
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #cesiumContainer { width: 100%; height: 100%; }
        
        /* UI é¢æ¿é€šç”¨æ ·å¼ */
        .panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
        }

        /* 1. é…ç½®é¢æ¿ (å·¦ä¸Š) */
        #configPanel {
            top: 20px;
            left: 20px;
            width: 280px;
        }
        
        /* 2. ä¿¡æ¯é¢æ¿ (å·¦ä¾§ä¸­éƒ¨) */
        #infoPanel {
            top: 480px; /* ä½äºé…ç½®é¢æ¿ä¸‹æ–¹ */
            left: 20px;
            width: 280px;
        }

        /* 3. æ§åˆ¶æŒ‰é’® (åº•éƒ¨å±…ä¸­) */
        #controlPanel {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        h3 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #4db8ff; }
        
        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .control-group { margin-bottom: 12px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        input[type="range"] { width: 100%; accent-color: #4db8ff; }
        input[type="color"] { width: 100%; height: 25px; border: none; padding: 0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; font-size: 13px; }
        .checkbox-item input { margin-right: 5px; }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background: #1976D2; }
        button.active { background: #ff9800; }

        /* æ•°æ®å€¼æ˜¾ç¤º */
        .val-display { color: #aaa; font-family: monospace; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div id="configPanel" class="panel">
        <h3>ğŸ“Š å‚æ•°é…ç½®</h3>
        
        <div class="control-group">
            <label>åŠé•¿è½´ (km) <span id="val-major">50</span></label>
            <input type="range" id="input-major" min="10" max="200" value="50" step="1">
        </div>

        <div class="control-group">
            <label>åŠçŸ­è½´ (km) <span id="val-minor">25</span></label>
            <input type="range" id="input-minor" min="5" max="100" value="25" step="1">
        </div>

        <div class="control-group">
            <label>å¡«å……é€æ˜åº¦ (%) <span id="val-fill-alpha">60</span></label>
            <input type="range" id="input-fill-alpha" min="0" max="100" value="60">
        </div>

        <div class="control-group">
            <label>è¾¹æ¡†å®½åº¦ (px) <span id="val-border-w">3</span></label>
            <input type="range" id="input-border-w" min="1" max="10" value="3">
        </div>

        <div class="control-group">
            <label>å¡«å……é¢œè‰²</label>
            <input type="color" id="input-fill-color" value="#00ff00">
        </div>

        <div class="checkbox-group">
            <div class="checkbox-item"><input type="checkbox" id="chk-fill" checked> å¡«å……</div>
            <div class="checkbox-item"><input type="checkbox" id="chk-border" checked> è¾¹æ¡†</div>
            <div class="checkbox-item"><input type="checkbox" id="chk-cone" checked> é”¥ä½“</div>
            <div class="checkbox-item"><input type="checkbox" id="chk-orbit" checked> è½¨é“</div>
        </div>
    </div>

    <div id="infoPanel" class="panel">
        <h3>â„¹ï¸ çŠ¶æ€ç›‘æ§</h3>
        <div style="font-size: 13px; line-height: 1.6;">
            <div>çŠ¶æ€: <span id="status-text" style="color:#0f0">æ’­æ”¾ä¸­</span></div>
            <div>ç»åº¦: <span id="sat-lon" class="val-display">0.00Â°</span></div>
            <div>çº¬åº¦: <span id="sat-lat" class="val-display">0.00Â°</span></div>
            <div>é«˜åº¦: <span class="val-display">800 km</span></div>
        </div>
    </div>

    <div id="controlPanel">
        <button id="btn-play">â¸ï¸ æš‚åœ</button>
        <button id="btn-view-top">ğŸŒ æ˜Ÿä¸‹ç‚¹è§†è§’</button>
        <button id="btn-view-follow">ğŸ›°ï¸ è·Ÿéšå«æ˜Ÿ</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/cesium@1.133/Build/Cesium/Cesium.js"></script>
    <script>
        // ==========================================
        // 0. åˆå§‹åŒ– Cesium (1.133ï¼Œåº•å›¾/åœ°å½¢æ— éœ€ token)
        // ==========================================
        Cesium.Ion.defaultAccessToken = null;

        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.UrlTemplateImageryProvider({
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c'],
                credit: 'Â© OpenStreetMap contributors',
                maximumLevel: 19
            }),
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
            baseLayerPicker: false,
            animation: false,
            timeline: false,
            navigationHelpButton: false,
            fullscreenButton: true,
            sceneModePicker: false,
            homeButton: true,
            geocoder: false,
            infoBox: false,
            selectionIndicator: false
        });

        try {
            if (viewer.cesiumWidget && viewer.cesiumWidget.creditContainer) {
                viewer.cesiumWidget.creditContainer.style.display = 'none';
            }
        } catch (_) {}

        // ==========================================
        // 1. å®šä¹‰å…¨å±€å˜é‡ä¸é…ç½® (PRD 2.2 & 2.3)
        // ==========================================
        
        const EARTH_RADIUS = 6371000; // ç±³
        const ORBIT_HEIGHT = 800000;  // ç±³
        const ORBIT_RADIUS = EARTH_RADIUS + ORBIT_HEIGHT;
        const INCLINATION = Cesium.Math.toRadians(51.6); // è½¨é“å€¾è§’
        const PERIOD = 5400; // 90åˆ†é’Ÿ = 5400ç§’
        
        // çŠ¶æ€ç®¡ç†
        const state = {
            semiMajor: 50000,
            semiMinor: 25000,
            fillAlpha: 0.6,
            borderWidth: 3,
            fillColor: Cesium.Color.fromCssColorString('#00ff00'),
            borderColor: Cesium.Color.fromCssColorString('#00ff00'),
            showFill: true,
            showBorder: true,
            showCone: true,
            showOrbit: true,
            isFollowing: false,
            isPlaying: true,
            currentTime: 0 // æ¨¡æ‹Ÿæ—¶é—´çš„ç§’æ•°
        };

        // ==========================================
        // 2. æ•°å­¦é€»è¾‘ï¼šè½¨é“ä¸æŠ•å½±è®¡ç®— (PRD 5.2)
        // ==========================================

        /**
         * è®¡ç®—å«æ˜Ÿåœ¨ç»™å®šæ—¶é—´çš„ä½ç½® (ç®€åŒ–çš„åœ†è½¨é“æ¨¡å‹)
         */
        function getSatellitePosition(timeSeconds) {
            const angle = (timeSeconds / PERIOD) * 2 * Math.PI;
            
            // åŸºç¡€å¹³é¢åœ†å‘¨è¿åŠ¨
            const x = ORBIT_RADIUS * Math.cos(angle);
            const y = ORBIT_RADIUS * Math.sin(angle);
            const z = 0;

            // åº”ç”¨è½¨é“å€¾è§’æ—‹è½¬ (ç»•Xè½´æ—‹è½¬)
            // Rx(inc) = [1 0 0; 0 cos -sin; 0 sin cos]
            // è¿™é‡Œç®€åŒ–ä¸ºï¼š
            const y_inc = y * Math.cos(INCLINATION);
            const z_inc = y * Math.sin(INCLINATION);

            // åŠ ä¸Šåˆå§‹ç»åº¦åç§» (PRD: 104Â°E, 30Â°N å¤§è‡´ä½ç½®)
            // ç®€å•å¤„ç†ï¼šå°†ç»“æœè½¬ä¸º Cartesian3 å¹¶æ—‹è½¬ä¸€å®šè§’åº¦ä»¥åŒ¹é…ä¸­å›½ä¸Šç©º
            let pos = new Cesium.Cartesian3(x, y_inc, z_inc);
            
            // æ—‹è½¬åæ ‡ç³»è®©å®ƒç»è¿‡å¤§æ¦‚ä¸­å›½åŒºåŸŸ
            const initialOffset = Cesium.Matrix3.fromRotationZ(Cesium.Math.toRadians(100));
            pos = Cesium.Matrix3.multiplyByVector(initialOffset, pos, new Cesium.Cartesian3());

            return pos;
        }

        /**
         * è®¡ç®—åœ°é¢æ¤­åœ†çš„è¾¹ç•Œç‚¹ (Cartesian3æ•°ç»„)
         */
        function computeEllipsePositions(satPosition) {
            const satCarto = Cesium.Cartographic.fromCartesian(satPosition);
            const centerLon = satCarto.longitude; // å¼§åº¦
            const centerLat = satCarto.latitude;  // å¼§åº¦
            
            // ç®€å•çš„å¢¨å¡æ‰˜æŠ•å½±è¿‘ä¼¼è®¡ç®—åç§»é‡
            const points = [];
            const count = 60; // é‡‡æ ·ç‚¹æ•°
            
            // ç±³è½¬å¼§åº¦
            const mPerDegLat = 111320; 
            const mPerDegLon = 111320 * Math.cos(centerLat);

            for (let i = 0; i <= count; i++) {
                const theta = (i / count) * 2 * Math.PI;
                
                // æ¤­åœ†å¹³é¢åç§» (ç±³)
                const dx = state.semiMajor * Math.cos(theta);
                const dy = state.semiMinor * Math.sin(theta);

                // è½¬æ¢ä¸ºç»çº¬åº¦
                const dLon = dx / mPerDegLon;
                const dLat = dy / mPerDegLat;

                points.push(Cesium.Cartesian3.fromDegrees(
                    Cesium.Math.toDegrees(centerLon) + dLon,
                    Cesium.Math.toDegrees(centerLat) + dLat
                ));
            }
            return points;
        }

        // ==========================================
        // 3. åˆ›å»º Cesium å®ä½“ (PRD 2.1 & 5.1)
        // ==========================================

        // --- A. è½¨é“çº¿ (é™æ€è®¡ç®—ä¸€æ¬¡) ---
        const orbitPositions = [];
        for(let t=0; t<PERIOD; t+=60) {
            orbitPositions.push(getSatellitePosition(t));
        }
        orbitPositions.push(orbitPositions[0]); // é—­åˆ

        const orbitEntity = viewer.entities.add({
            name: 'è½¨é“çº¿',
            polyline: {
                positions: orbitPositions,
                width: 2,
                material: new Cesium.ColorMaterialProperty(new Cesium.ConstantProperty(Cesium.Color.CYAN.withAlpha(0.5))),
                show: new Cesium.CallbackProperty(() => state.showOrbit, false)
            }
        });

        // --- B. å«æ˜Ÿå®ä½“ (åŠ¨æ€ä½ç½®) ---
        const satelliteEntity = viewer.entities.add({
            name: 'å«æ˜Ÿ',
            position: new Cesium.CallbackProperty((time, result) => {
                return getSatellitePosition(state.currentTime);
            }, false),
            point: {
                pixelSize: 20,
                color: Cesium.Color.YELLOW,
                outlineColor: Cesium.Color.RED,
                outlineWidth: 2
            },
            label: {
                text: 'ğŸ›°ï¸ å«æ˜Ÿ',
                font: '14px sans-serif',
                pixelOffset: new Cesium.Cartesian2(0, -20),
                fillColor: Cesium.Color.WHITE
            }
        });

        // --- C. åœ°é¢æŠ•å½±æ¤­åœ† (åŠ¨æ€å½¢çŠ¶) ---
        // ä½¿ç”¨ CallbackProperty å®ç°å®æ—¶æ›´æ–°è€Œä¸é”€æ¯å®ä½“
        const projectionEntity = viewer.entities.add({
            name: 'åœ°é¢æŠ•å½±',
            polygon: {
                hierarchy: new Cesium.CallbackProperty(() => {
                    const satPos = getSatellitePosition(state.currentTime);
                    const positions = computeEllipsePositions(satPos);
                    return new Cesium.PolygonHierarchy(positions);
                }, false),
                material: new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(() => state.fillColor.withAlpha(state.fillAlpha / 100), false)),
                show: new Cesium.CallbackProperty(() => state.showFill, false),
                classificationType: Cesium.ClassificationType.TERRAIN // è´´åœ°
            },
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    const satPos = getSatellitePosition(state.currentTime);
                    return computeEllipsePositions(satPos);
                }, false),
                width: new Cesium.CallbackProperty(() => state.borderWidth, false),
                material: new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(() => state.borderColor, false)),
                clampToGround: true,
                show: new Cesium.CallbackProperty(() => state.showBorder, false)
            }
        });

        // --- D. é”¥ä½“ä¾§é¢ (PRD 2.1.D) ---
        // å®ç°æŠ€å·§ï¼šä½¿ç”¨ä¸€ä¸ªå¤šè¾¹å½¢ï¼ŒåŒ…å«å«æ˜Ÿç‚¹å’Œåœ°é¢æ¤­åœ†ç‚¹ï¼Œè®¾ç½® perPositionHeight: true
        const coneEntity = viewer.entities.add({
            name: 'é”¥ä½“ä¾§é¢',
            polygon: {
                hierarchy: new Cesium.CallbackProperty(() => {
                    const satPos = getSatellitePosition(state.currentTime);
                    const groundPoints = computeEllipsePositions(satPos);
                    if (!state.showCone) return new Cesium.PolygonHierarchy(groundPoints);
                    
                    // æ„é€  "å¸ç¯·" å½¢çŠ¶ï¼šä¸­å¿ƒç‚¹æ˜¯å«æ˜Ÿï¼Œè¾¹ç¼˜æ˜¯åœ°é¢æ¤­åœ†
                    // Cesium polygon å¦‚æœç‚¹çš„é«˜åº¦ä¸åŒï¼Œä¼šè‡ªåŠ¨å½¢æˆä¸‰è§’ç½‘
                    // é¡ºåºï¼šå«æ˜Ÿ -> åœ°é¢ç‚¹1 -> åœ°é¢ç‚¹2 ... -> å«æ˜Ÿ (å®é™…ä¸Šåªéœ€è¦ä¸­å¿ƒå’Œå¤–ç¯)
                    // æ›´ç®€å•çš„æ–¹æ³•æ˜¯è®©å«æ˜Ÿä½œä¸ºä¸­å¿ƒï¼Œä½† Cesium Polygon éœ€è¦å¹³é¢æˆ–æ›²é¢ã€‚
                    // æ›´å¥½çš„æ¨¡æ‹Ÿæ–¹æ³•ï¼šæ‰‹åŠ¨æ„å»ºä¸‰è§’å½¢åˆ—è¡¨å¤ªæ…¢ã€‚
                    // æ›¿ä»£æ–¹æ¡ˆï¼šåˆ›å»ºä¸€ä¸ª Entityï¼Œå…¶ hierarchy æ˜¯ [å«æ˜Ÿç‚¹, ...åœ°é¢æ‰€æœ‰ç‚¹, å«æ˜Ÿç‚¹]
                    // è¿™ä¼šåˆ›å»ºä¸€ä¸ª "æ‰‡å­" æˆ– "å¸ç¯·"ã€‚
                    
                    // ä¸ºäº†æ€§èƒ½å’Œæ•ˆæœï¼Œè¿™é‡Œæˆ‘ä»¬åªå–åœ°é¢æ¤­åœ†çš„å‡ ä¸ªå…³é”®ç‚¹å’Œå«æ˜Ÿè¿æ¥ï¼Œæˆ–è€…ç›´æ¥ç”¨æ‰€æœ‰ç‚¹
                    // æ³¨æ„ï¼šPolygon ä¼šå°è¯•å°é—­ã€‚
                    // æŠ€å·§ï¼šPolygon çš„ center æ˜¯å«æ˜Ÿï¼Œå¤–ç¯æ˜¯åœ°é¢ã€‚
                    
                    return new Cesium.PolygonHierarchy(groundPoints); 
                }, false),
                // å…³é”®å±æ€§ï¼šæ¯ä¸ªç‚¹ä½¿ç”¨å…¶å®é™…é«˜åº¦
                perPositionHeight: true, 
                // è¿™é‡Œçš„é€»è¾‘ç¨å¾® trickyã€‚æ ‡å‡† Polygon æ˜¯å¡«å……å¹³é¢ã€‚
                // è¦åšé”¥ä½“ï¼Œå…¶å®æœ€å®Œç¾çš„æ˜¯ "Pyramid" æˆ–è€…è‡ªå®šä¹‰ Geometryã€‚
                // ä½†åœ¨è¿™ä¸ª Demo çº§åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Polygon çš„ä¸€ä¸ªç‰¹æ€§ï¼š
                // å¦‚æœæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¤šè¾¹å½¢ï¼Œå®ƒçš„ hierarchy æ˜¯åœ°é¢æ¤­åœ†ï¼Œ
                // ç„¶åæˆ‘ä»¬è®¾ç½® extrudedHeight ä¸ºå«æ˜Ÿé«˜åº¦... ä¸å¯¹ï¼Œé‚£æ˜¯æ‹‰ä¼¸æŸ±ä½“ã€‚
                
                // --- ä¿®æ­£æ–¹æ¡ˆ ---
                // ä½¿ç”¨ "Wall" æ— æ³•å°é¡¶ã€‚
                // ç®€å•ä¸”é«˜æ€§èƒ½æ–¹æ¡ˆï¼šåªç”» 8 æ¡çº¿ä»£è¡¨é”¥ä½“æ£±ï¼Œæˆ–è€…
                // ç»´æŒ PRD çš„ "ä¸‰è§’å½¢ç½‘æ ¼" è¦æ±‚ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ Polygon é…ç½®
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªåŠé€æ˜çš„ "Wall" è¿æ¥åœ°é¢å’Œå«æ˜Ÿï¼Ÿä¸ï¼ŒWall æ˜¯å‚ç›´çš„ã€‚
                
                // æœ€ç»ˆæ–¹æ¡ˆï¼šä½¿ç”¨è‡ªå®šä¹‰ Geometry å¤ªé‡ã€‚
                // æˆ‘ä»¬ä½¿ç”¨ä¸€ç»„ TriangleMesh æˆ–è€…ç®€å•çš„ Polyline è¿çº¿æ¥æ¨¡æ‹Ÿé”¥ä½“éª¨æ¶ï¼Œ
                // åŠ ä¸Šä¸€ä¸ªç¨å¾®é€æ˜çš„ Pyramid (å¦‚æœåœ†é”¥)ã€‚
                // é‰´äºè¿™æ˜¯ PRD Demoï¼Œæˆ‘ä»¬ç”¨ Entity API æœ€æ¥è¿‘çš„æ–¹å¼ï¼š
                // å¿½ç•¥ä¾§é¢å¡«å……ï¼Œåªç”»â€œæ£±â€è¿æ¥å«æ˜Ÿå’Œæ¤­åœ†è¾¹ç¼˜ï¼Œè¿™åœ¨è§†è§‰ä¸Šä¹Ÿå¾ˆæ¸…æ¥šã€‚
                // æˆ–è€…ï¼š
                // ä½¿ç”¨ Cylinder (åœ†æŸ±/åœ†é”¥) å‡ ä½•ä½“ï¼Œä½† PRD è¦æ±‚æ˜¯æ¤­åœ†é”¥ã€‚
                
                // å¦¥åæ–¹æ¡ˆï¼šä¸ºäº†å•æ–‡ä»¶å¯è¿è¡Œä¸”ä¸å¼•å…¥å¤æ‚ GeometryPipelineï¼š
                // æˆ‘å°†åˆ›å»ºä¸€ä¸ªè·Ÿéšå«æ˜Ÿçš„ ColorMaterialï¼Œå…¶å½¢çŠ¶ç”± Callback å†³å®šã€‚
                // è¿™é‡Œæš‚æ—¶ç”¨â€œçº¿æ¡ç½‘ç»œâ€ä»£è¡¨é”¥ä½“ä¾§é¢ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªè¿‘ä¼¼çš„ Cylinder (å¦‚æœæ˜¯åœ†å½¢çš„)ã€‚
                // é‰´äºè¦æ±‚æ¤­åœ†ï¼Œæˆ‘ä»¬ç”» 8 æ¡çº¿è¿æ¥å«æ˜Ÿå’Œåœ°é¢æ¤­åœ†è¾¹ç¼˜ã€‚
                material: new Cesium.ColorMaterialProperty(new Cesium.Color(0, 1, 0, 0.0)) // éšè—è¿™é‡Œçš„å¤šè¾¹å½¢ï¼Œä¸‹é¢ç”¨çº¿
            }
        });

        // æ›¿ä»£é”¥ä½“ä¾§é¢ï¼šä½¿ç”¨çº¿æ¡ç½‘ç»œ (Visual Cone)
        const coneLines = viewer.entities.add({
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    if (!state.showCone) return [];
                    const satPos = getSatellitePosition(state.currentTime);
                    const groundPoints = computeEllipsePositions(satPos);
                    const lines = [];
                    // æ¯éš” 10 ä¸ªç‚¹è¿ä¸€æ¡çº¿ï¼Œå½¢æˆç¬¼çŠ¶é”¥ä½“
                    for (let i = 0; i < groundPoints.length - 1; i += 10) {
                        lines.push(satPos);
                        lines.push(groundPoints[i]);
                    }
                    return lines;
                }, false),
                width: 1,
                material: new Cesium.ColorMaterialProperty(new Cesium.Color(0, 1, 0, 0.3))
            }
        });


        // ==========================================
        // 4. åŠ¨ç”»å¾ªç¯ä¸äº¤äº’é€»è¾‘ (PRD 4.1 & 4.2)
        // ==========================================

        // æ¸¸æˆå¾ªç¯
        viewer.scene.preUpdate.addEventListener(function(scene, time) {
            if (state.isPlaying) {
                // æ—¶é—´å€é€Ÿ 50x (PRD 2.2)
                state.currentTime += (1 / 60) * 50; 
                if (state.currentTime > PERIOD) state.currentTime = 0;
            }

            // æ›´æ–°ä¿¡æ¯é¢æ¿
            const satPos = getSatellitePosition(state.currentTime);
            const carto = Cesium.Cartographic.fromCartesian(satPos);
            document.getElementById('sat-lon').innerText = Cesium.Math.toDegrees(carto.longitude).toFixed(2) + "Â°";
            document.getElementById('sat-lat').innerText = Cesium.Math.toDegrees(carto.latitude).toFixed(2) + "Â°";

            // ç›¸æœºè·Ÿéš
            if (state.isFollowing) {
                viewer.camera.lookAt(
                    satPos, 
                    new Cesium.HeadingPitchRange(0, -Cesium.Math.toRadians(45), 5000000)
                );
            }
        });

        // ==========================================
        // 5. UI äº‹ä»¶ç»‘å®š
        // ==========================================

        // æ»‘å—è¾“å…¥
        function bindSlider(id, stateKey, displayId) {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                state[stateKey] = parseFloat(e.target.value);
                if (displayId) document.getElementById(displayId).innerText = e.target.value;
            });
        }

        bindSlider('input-major', 'semiMajor', 'val-major');
        bindSlider('input-minor', 'semiMinor', 'val-minor');
        bindSlider('input-fill-alpha', 'fillAlpha', 'val-fill-alpha');
        bindSlider('input-border-w', 'borderWidth', 'val-border-w');

        // é¢œè‰²é€‰æ‹©
        document.getElementById('input-fill-color').addEventListener('input', (e) => {
            state.fillColor = Cesium.Color.fromCssColorString(e.target.value);
            state.borderColor = Cesium.Color.fromCssColorString(e.target.value); // åŒæ­¥è¾¹æ¡†é¢œè‰²
        });

        // å¤é€‰æ¡†
        document.getElementById('chk-fill').addEventListener('change', e => state.showFill = e.target.checked);
        document.getElementById('chk-border').addEventListener('change', e => state.showBorder = e.target.checked);
        document.getElementById('chk-cone').addEventListener('change', e => state.showCone = e.target.checked);
        document.getElementById('chk-orbit').addEventListener('change', e => state.showOrbit = e.target.checked);

        // æŒ‰é’®æ§åˆ¶
        const btnPlay = document.getElementById('btn-play');
        btnPlay.addEventListener('click', () => {
            state.isPlaying = !state.isPlaying;
            btnPlay.innerText = state.isPlaying ? "â¸ï¸ æš‚åœ" : "â–¶ï¸ æ’­æ”¾";
            document.getElementById('status-text').innerText = state.isPlaying ? "æ’­æ”¾ä¸­" : "å·²æš‚åœ";
            document.getElementById('status-text').style.color = state.isPlaying ? "#0f0" : "#ff0";
        });

        document.getElementById('btn-view-top').addEventListener('click', () => {
            state.isFollowing = false;
            viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY); // è§£é™¤é”å®š
            const satPos = getSatellitePosition(state.currentTime);
            viewer.camera.flyTo({
                destination: satPos, // é£åˆ°å«æ˜Ÿä½ç½®
                orientation: {
                    heading: 0,
                    pitch: Cesium.Math.toRadians(-90), // æ­£ä¸‹è§†
                    roll: 0
                },
                endTransform: Cesium.Matrix4.IDENTITY
            });
            // å¾®è°ƒé«˜åº¦çœ‹æ¸…åœ°é¢
            setTimeout(() => {
                viewer.camera.zoomOut(200000);
            }, 2000);
        });

        document.getElementById('btn-view-follow').addEventListener('click', (e) => {
            state.isFollowing = !state.isFollowing;
            e.target.classList.toggle('active', state.isFollowing);
            if (!state.isFollowing) {
                viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
            }
        });

        // åˆå§‹è§†è§’è®¾ç½®
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(104, 20, 10000000)
        });

    </script>
</body>
</html>